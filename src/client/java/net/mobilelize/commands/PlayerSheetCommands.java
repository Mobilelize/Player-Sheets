package net.mobilelize.commands;

import com.mojang.brigadier.arguments.BoolArgumentType;
import com.mojang.brigadier.suggestion.SuggestionProvider;
import net.fabricmc.fabric.api.client.command.v2.FabricClientCommandSource;
import net.minecraft.command.CommandSource;
import net.mobilelize.Casting;
import net.mobilelize.suggestions.Suggestions;
import com.mojang.brigadier.arguments.StringArgumentType;
import net.fabricmc.fabric.api.client.command.v2.ClientCommandRegistrationCallback;
import net.minecraft.text.Text;
import net.minecraft.client.MinecraftClient;

import static net.fabricmc.fabric.api.client.command.v2.ClientCommandManager.literal;
import static net.fabricmc.fabric.api.client.command.v2.ClientCommandManager.argument;
import static net.mobilelize.commands.PlayerSheetFunctions.*;
import static net.mobilelize.suggestions.Suggestions.*;

public class PlayerSheetCommands {

    private static final PlayerSheetFunctions functions = new PlayerSheetFunctions();

    private static final SuggestionProvider<FabricClientCommandSource> macroTypeSuggestions = (context, builder) -> {
        if (CommandSource.shouldSuggest(builder.getRemaining().toLowerCase(), "add")) {
            builder.suggest("add");
        }
        if (CommandSource.shouldSuggest(builder.getRemaining().toLowerCase(), "remove")) {
            builder.suggest("remove");
        }
        return builder.buildFuture();
    };

    private static final SuggestionProvider<FabricClientCommandSource> getOnlinePlayers = (context, builder) -> {
        String[] suggestions = getAllOnlinePlayers(); // Get online players
        for (String player : suggestions) {
            if (CommandSource.shouldSuggest(builder.getRemaining().toLowerCase(), player.toLowerCase())) {
                builder.suggest(player);
            }
        }
        return builder.buildFuture();
    };

    private static final SuggestionProvider<FabricClientCommandSource> getConfigNames = (context, builder) -> {
        String[] suggestions = getAllNamesFromConfig(); // Get names from config
        for (String player : suggestions) {
            if (CommandSource.shouldSuggest(builder.getRemaining().toLowerCase(), player.toLowerCase())) {
                builder.suggest(player);
            }
        }
        return builder.buildFuture();
    };

    public static void registerClientCommands() {
        ClientCommandRegistrationCallback.EVENT.register((dispatcher, registryAccess) -> {
            // Register the main /ps command
            Suggestions Suggestion = null;
            dispatcher.register(
                    literal("ps").executes(context -> showHelp())
                            .then(literal("toggle")
                                    .executes(context -> togglePlayerSource())
                                    .then(literal("addKeyBind").executes(context -> {
                                        return toggleAddKeyBind();  // Executes the toggleAddKeyBind method
                                    }))
                                    .then(literal("removeKeyBind").executes(context -> {
                                        return toggleRemoveKeyBind();  // Executes the toggleRemoveKeyBind method
                                    }))
                                    .then(literal("getPlayers").executes(context -> {
                                        return togglePlayerSource();  // Executes the listPlayers method
                                    }))
                            )

                            .then(literal("help").executes(context -> showHelp()))
                            .then(literal("clear")
                                    .executes(context -> {
                                        // Clear the player list
                                        PlayerSheetFunctions.clearPlayers();

                                        MinecraftClient.getInstance().player.sendMessage(Text.literal("Â§cCleared player list."), false);
                                        return 1; // Return success
                                    })
                            )
                            .then(literal("add")
                                    .then(argument("playerName", StringArgumentType.string())
                                            .suggests(getOnlinePlayers)
                                            .executes(context -> {
                                                String playerName = StringArgumentType.getString(context, "playerName");
                                                return functions.addPlayer(playerName);
                                            })
                                    )
                            )
                            .then(literal("a") // Short command for add
                                    .then(argument("playerName", StringArgumentType.string())
                                            .suggests(getOnlinePlayers)
                                            .executes(context -> {
                                                String playerName = StringArgumentType.getString(context, "playerName");
                                                return functions.addPlayer(playerName);
                                            })
                                    )
                            )
                            .then(literal("remove")
                                    .then(argument("playerName", StringArgumentType.string())
                                            .suggests(getConfigNames)
                                            .executes(context -> {
                                                String playerName = StringArgumentType.getString(context, "playerName");
                                                return functions.removePlayer(playerName);
                                            })
                                    )
                            )
                            .then(literal("r") // Short command for remove
                                    .then(argument("playerName", StringArgumentType.string())
                                            .suggests(getConfigNames)
                                            .executes(context -> {
                                                String playerName = StringArgumentType.getString(context, "playerName");
                                                return functions.removePlayer(playerName);
                                            })
                                    )
                            )
                            .then(literal("list").executes(context -> functions.listPlayers()))
                            .then(literal("l") // Short command for list
                                    .executes(context -> functions.listPlayers())
                            )
                            .then(literal("macro")
                                    .executes(context -> showMacroList())
                                    .then(literal("add")
                                            .then(argument("type", StringArgumentType.word()) // Argument for "add" or "remove"
                                                    .suggests(macroTypeSuggestions)  // Suggest "add" and "remove"
                                                    .then(argument("command", StringArgumentType.greedyString()) // Command to add
                                                            .suggests((context, builder) -> {
                                                                // Determine which suggestions to provide based on the type entered
                                                                String type = context.getArgument("type", String.class);
                                                                if ("add".equalsIgnoreCase(type)) {
                                                                    return CommandSource.suggestMatching(getMacroCommands("add"), builder);
                                                                } else if ("remove".equalsIgnoreCase(type)) {
                                                                    return CommandSource.suggestMatching(getMacroCommands("remove"), builder);
                                                                }
                                                                // Default to empty suggestions if type is not recognized
                                                                return builder.buildFuture();
                                                            })//.suggests(getMacroCommands("add"))
                                                            .executes(context -> {
                                                                String type = StringArgumentType.getString(context, "type");
                                                                String command = StringArgumentType.getString(context, "command");
                                                                return functions.addMacro(type, command);
                                                            })
                                                    )
                                            )
                                    )
                                    .then(literal("remove")
                                            .then(argument("type", StringArgumentType.word()) // Argument for "add" or "remove"
                                                    .suggests(macroTypeSuggestions)  // Suggest "add" and "remove"
                                                    .then(argument("command", StringArgumentType.greedyString()) // Command to remove
                                                            .suggests((context, builder) -> {
                                                                // Determine which suggestions to provide based on the type entered
                                                                String type = context.getArgument("type", String.class);
                                                                if ("add".equalsIgnoreCase(type)) {
                                                                    return CommandSource.suggestMatching(getMacroCommands("add"), builder);
                                                                } else if ("remove".equalsIgnoreCase(type)) {
                                                                    return CommandSource.suggestMatching(getMacroCommands("remove"), builder);
                                                                }
                                                                // Default to empty suggestions if type is not recognized
                                                                return builder.buildFuture();
                                                            })
                                                            .executes(context -> {
                                                                String type = StringArgumentType.getString(context, "type");
                                                                String command = StringArgumentType.getString(context, "command");
                                                                return functions.removeMacro(type, command);
                                                            })
                                                    )
                                            )
                                    )
                                    .then(literal("toggle")
                                            .then(argument("type", StringArgumentType.word()) // Argument for "add" or "remove"
                                                    .suggests(macroTypeSuggestions)  // Suggest "add" and "remove"
                                                    .executes(context -> {
                                                        // Clear all macros
                                                        String type = StringArgumentType.getString(context, "type");
                                                        functions.toggleMacroFlip(type);
                                                        return 1; // Return success
                                                    })
                                                    .then(argument("enabled", BoolArgumentType.bool()) // true or false
                                                            .executes(context -> {
                                                                String type = StringArgumentType.getString(context, "type");
                                                                boolean enabled = BoolArgumentType.getBool(context, "enabled");
                                                                return functions.toggleMacro(type, enabled);
                                                            })
                                                    )
                                            )
                                    )
                                    .then(literal("list")
                                            .executes(context -> {
                                                return showMacroList(); // Call the method to show the macro list
                                            }))
                                    .then(literal("clear")
                                            .executes(context -> {
                                                // Clear all macros
                                                clearMacros("all");
                                                return 1; // Return success
                                            })
                                            .then(argument("type", StringArgumentType.word()) // Argument for "add" or "remove"
                                                    .suggests(macroTypeSuggestions)  // Suggest "add" and "remove"
                                                    .executes(context -> {
                                                        String type = StringArgumentType.getString(context, "type");
                                                        return PlayerSheetFunctions.clearMacros(type);
                                                    })
                                            )
                                    )
            ));
        });
    }

    private static int showHelp() {
        MinecraftClient client = MinecraftClient.getInstance();

        client.player.sendMessage(Text.literal(
                "\nÂ§8Â§m------------------------------------------\n" +
                "Â§f>>>Â§6Â§lPlayer Sheets Help MenuÂ§rÂ§f<<<\n" +
                "Â§8Â§m------------------------------------------\n" +
                "\n" +
                "Â§7Â§lCommands:\n" +
                "Â§6/ps help Â§7- Â§fShow this help menu.\n" +
                "Â§6/ps add [playerName] Â§7- Â§fAdd a player.\n" +
                "Â§6/ps remove [playerName] Â§7- Â§fRemove a player.\n" +
                "Â§6/ps list Â§7- Â§fList all tracked players.\n" +
                "Â§6/ps toggle [addKeyBind/removeKeyBind/getPlayers]Â§7- Â§fToggle between Tab List and Rendered Players, and a toggle for Add and Remove Key Bind.\n" +
                "Â§6/ps a [playerName] Â§7- Â§fShort command to add a player.\n" +
                "Â§6/ps r [playerName] Â§7- Â§fShort command to remove a player.\n" +
                "Â§6/ps l Â§7- Â§fShort command to list all players.\n" +
                "\n" +
                "Â§8Â§m------------------------------------------\n" +
                "Â§f>>>Â§6Â§lMacros ManagementÂ§rÂ§f<<<\n" +
                "Â§8Â§m------------------------------------------\n" +
                "\n" +
                "Â§7Â§lCommands:\n" +
                "Â§6/ps macro add [add/remove] [command] Â§7- Â§fAdd a macro to /ps add or /ps remove.\n" +
                "Â§6/ps macro remove [add/remove] [command] Â§7- Â§fRemove a macro from /ps add or /ps remove.\n" +
                "Â§6/ps macro toggle [add/remove] [true/false] Â§7- Â§fEnable or disable macros for /ps add or /ps remove.\n" +
                "Â§6/ps macro list Â§7- Â§fList all macros.\n" +
                "Â§6/ps macro clear [add/remove/all] Â§7- Â§fClear macros for /ps add, /ps remove, or all.\n" +
                "\n" +
                "Â§8Â§m------------------------------------------\n" +
                "Â§cMacros allow you to automate commands you frequently use.\n" +
                "Â§cYou can create two types of macros:\n" +
                "Â§7- Â§a'add': Executes commands when a player is added.\n" +
                "Â§7- Â§a'remove': Executes commands when a player is removed.\n" +
                "\n" +
                "Â§7For example:\n" +
                "Â§6/ps macro add Â§aadd Â§6gamemode creative ${name} Â§7- Â§fGive creative mode to the player added to the list.\n" +
                "Â§6/ps macro add Â§aremove Â§6${chat} Goodbye ${name} Â§7- Â§fSends a goodbye message in chat with the removed player name from the list.\n" +
                "\n" +
                "Â§8Â§m------------------------------------------\n"), false);

        return 1;
    }

    private static int showMacroList() {
        MinecraftClient client = MinecraftClient.getInstance();

        // Load the current macro states
        PlayerSheetFunctions.MacroState state = functions.loadMacroState();

        StringBuilder macroList = new StringBuilder("\nÂ§8Â§m------------------------------------------\n" +
                "Â§f>>>Â§6Â§lCurrent MacrosÂ§rÂ§f<<<\n" +
                "Â§8Â§m------------------------------------------\n" + "\nÂ§6Add Macros (Active: " + (state.add.enabled ? "Â§aEnabled" : "Â§cDisabled") + "Â§6):");

        for (String command : state.add.commands) {
            macroList.append("\nÂ§f  - ").append(command);
        }

        macroList.append("\n\n").append("Â§6Remove Macros (Active: ").append(state.remove.enabled ? "Â§aEnabled" : "Â§cDisabled").append("Â§6):");

        // Add details for the 'remove' macros
        for (String command : state.remove.commands) {
            macroList.append("\nÂ§f  - ").append(command);
        }

        //End of message
        client.player.sendMessage(Text.literal(macroList + "\n\nÂ§8Â§m------------------------------------------\n"), false);

        return 1;
    }
}
